#include <avr/io.h>
#include <avr/interrupt.h>

#define LED_PIN PB1

volatile uint16_t t2_10ms_count = 0;   // counts 10 ms steps for the 3 s timer

// --------- Helpers to start/stop timers ---------
void start_timer1_1s(void) {
  TCNT1 = 0;
  // Prescaler 1024 -> 1 s when OCR1A = 15624
  TCCR1B |= (1 << CS12) | (1 << CS10);
}

void stop_timer1(void) {
  TCCR1B &= ~((1 << CS12) | (1 << CS11) | (1 << CS10));
}

void start_timer2_3s(void) {
  TCNT2 = 0;
  t2_10ms_count = 0;
  // Prescaler 1024 -> 10 ms when OCR2A = 155
  TCCR2B |= (1 << CS22) | (1 << CS20);
}

void stop_timer2(void) {
  TCCR2B &= ~((1 << CS22) | (1 << CS21) | (1 << CS20));
}

// ------------------------------------------------

void setup() {
  // LED as output, start OFF
  DDRB  |= (1 << LED_PIN);
  PORTB &= ~(1 << LED_PIN);

  // ---------- Timer1: 1 s period (CTC) ----------
  TCCR1A = 0;
  TCCR1B = 0;

  // 16 MHz / 1024 = 15625 ticks per second
  // For 1 s: OCR1A = 15625 - 1 = 15624
  OCR1A = 15624;

  // CTC mode (TOP = OCR1A)
  TCCR1B |= (1 << WGM12);

  // Enable Timer1 Compare A interrupt
  TIMSK1 |= (1 << OCIE1A);

  // ---------- Timer2: 10 ms base for 3 s (CTC) ----------
  TCCR2A = 0;
  TCCR2B = 0;

  // 16 MHz / 1024 = 15625 Hz
  // (OCR2A + 1) / 15625 â‰ˆ 0.01 s  -> OCR2A = 155 (~9.984 ms)
  OCR2A = 155;

  // CTC mode (TOP = OCR2A)
  TCCR2A |= (1 << WGM21);

  // Enable Timer2 Compare A interrupt
  TIMSK2 |= (1 << OCIE2A);

  // Start the 3 s timer; 1 s timer stays stopped for now
  start_timer2_3s();

  // Enable global interrupts
  sei();
}

void loop() {
  // Nothing here; everything is interrupt-driven
}

// ---------- ISRs ----------

// Timer2 Compare A: fires every ~10 ms while Timer2 is running
ISR(TIMER2_COMPA_vect) {
  t2_10ms_count++;
  if (t2_10ms_count >= 300) {      // ~3 s (300 * 10 ms)
    PORTB |= (1 << LED_PIN);       // LED ON
    stop_timer2();                 // stop 3 s timer
    start_timer1_1s();             // start 1 s timer
  }
}

// Timer1 Compare A: fires every 1 s while Timer1 is running
ISR(TIMER1_COMPA_vect) {
  PORTB &= ~(1 << LED_PIN);        // LED OFF
  stop_timer1();                   // stop 1 s timer

  // If you want this sequence to repeat forever,
  // uncomment the next line:
  // start_timer2_3s();
}
