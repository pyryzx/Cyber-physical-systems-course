#define F_CPU 16000000UL
#include <avr/io.h>
#include <util/delay.h>

void uart_init() {
  // Baud = 115200 → UBRR = 8
  uint16_t ubrr_val = 8;
  UBRR0H = ubrr_val >> 8;
  UBRR0L = ubrr_val;

  // Enable transmitter
  UCSR0B = (1 << TXEN0);

  // 7E2 format:
  // - Even parity → UPM01 = 1, UPM00 = 0
  // - 2 stop bits → USBS0 = 1
  // - 7-bit data  → UCSZ01 = 1, UCSZ00 = 0, UCSZ02 = 0
  UCSR0C = (1 << UPM01) | (1 << USBS0) | (1 << UCSZ01);
}

void uart_send(uint8_t c) {
  while (!(UCSR0A & (1 << UDRE0))); // wait for buffer
  UDR0 = c;
}

int main() {
  uart_init();

  const char* msg = "Hello 7E2 UART\n";

  while (1) {
    const char* p = msg;
    while (*p) uart_send(*p++);
    _delay_ms(500);
  }
}